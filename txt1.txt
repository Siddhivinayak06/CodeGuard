"use client";

import { useState, useEffect } from "react";
import dynamic from "next/dynamic";
import { cpp } from "@codemirror/lang-cpp";
import { python } from "@codemirror/lang-python";
import { oneDark } from "@codemirror/theme-one-dark";
import { createClient } from "@/lib/supabase/client";
import { useTheme } from "next-themes";

const CodeMirror = dynamic(() => import("@uiw/react-codemirror"), { ssr: false });

// ---------------------- Types ----------------------
interface TestCase {
  input: string;
  expected_output: string;
  is_hidden?: boolean;
  time_limit_ms?: number;
  memory_limit_kb?: number;
}

interface Practical {
  id: number;
  title: string;
  subject_id: number;
  description?: string;
  language?: string;
  deadline: string;
  max_marks: number;
}

interface Subject {
  id: number;
  subject_name: string;
}

interface PracticalFormProps {
  practical: Practical | null;
  subjects: Subject[];
  supabase: any;
  sampleCode?: string;
  setSampleCode: (code: string) => void;
  sampleLanguage?: string;
  setSampleLanguage: (lang: string) => void;
  onClose: () => void;
  onSaved: () => void;
}

export default function PracticalForm({
  practical,
  subjects,
  supabase,
  sampleCode = "",
  setSampleCode,
  sampleLanguage = "c",
  setSampleLanguage,
  onClose,
  onSaved,
}: PracticalFormProps) {
  const [form, setForm] = useState<Practical>({
    id: 0,
    title: "",
    subject_id: subjects[0]?.id || 0,
    description: "",
    language: "",
    deadline: new Date().toISOString().slice(0, 16),
    max_marks: 100,
  });

  const [testCases, setTestCases] = useState<TestCase[]>([
    { input: "", expected_output: "", is_hidden: false, time_limit_ms: 2000, memory_limit_kb: 65536 },
  ]);

  const [step, setStep] = useState<1 | 2>(1); // Step 1: Details, Step 2: Assign Students
  const [students, setStudents] = useState<any[]>([]);
  const [selectedStudents, setSelectedStudents] = useState<any[]>([]);
  const [assignmentDeadline, setAssignmentDeadline] = useState(form.deadline);
  const [notes, setNotes] = useState("");
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const { theme } = useTheme();
  const supabaseClient = createClient();

  // ---------------------- Effects ----------------------
  useEffect(() => {
    if (practical) {
      setForm({ ...practical, deadline: practical.deadline.slice(0, 16) });
      supabase.from("test_cases").select("*").eq("practical_id", practical.id).then(({ data }) => {
        if (data && data.length > 0) setTestCases(data);
      });
      setAssignmentDeadline(practical.deadline.slice(0, 16));
    }
  }, [practical, supabase]);

  useEffect(() => {
    const fetchStudents = async () => {
      setError(null);
      try {
        const { data, error } = await supabaseClient
          .from("users")
          .select("uid, name, email")
          .eq("role", "student");

        if (error) return setError(error.message);
        if (data) setStudents(data);
      } catch (err: any) {
        console.error(err);
        setError("Failed to load students.");
      }
    };
    fetchStudents();
  }, [supabaseClient]);

  // ---------------------- Handlers ----------------------
  const handleInput = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleNext = () => {
    if (step === 1 && (!form.title || !form.subject_id || !form.deadline)) {
      return alert("Please fill all required fields in Practical Details.");
    }
    setStep(2);
  };

  const handleBack = () => setStep(1);

  const handleTestCaseChange = (index: number, field: keyof TestCase, value: any) => {
    const updated = [...testCases];
    updated[index][field] = value;
    setTestCases(updated);
  };

  const addTestCase = () =>
    setTestCases([...testCases, { input: "", expected_output: "", is_hidden: false, time_limit_ms: 2000, memory_limit_kb: 65536 }]);

  const removeTestCase = (index: number) => setTestCases(testCases.filter((_, i) => i !== index));

  const getLanguageExtension = () => (sampleLanguage?.toLowerCase() === "python" ? python() : cpp());

  const toggleStudent = (student: any) => {
    setSelectedStudents(prev =>
      prev.find(s => s.uid === student.uid)
        ? prev.filter(s => s.uid !== student.uid)
        : [...prev, student]
    );
  };

  const assign = async () => {
    if (selectedStudents.length === 0) return;

    setLoading(true);
    try {
      const response = await fetch("/api/admin/practicals/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          practical_id: form.id,
          student_ids: selectedStudents.map(s => s.uid),
          assigned_deadline: assignmentDeadline,
          notes,
        }),
      });

      const result = await response.json();
      if (result.success) {
        alert(result.message || "Practical assigned successfully!");
        onSaved();
      } else {
        alert(result.error || "Failed to assign practical.");
      }
    } catch (err) {
      console.error(err);
      alert("Failed to assign practical.");
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      let practicalId = form.id;

      if (practicalId && practicalId > 0) {
        const { data } = await supabase.from("practicals").update(form).eq("id", practicalId).select().single();
        practicalId = data.id;
        await supabase.from("test_cases").delete().eq("practical_id", practicalId);
      } else {
        const { data } = await supabase.from("practicals").insert(form).select().single();
        practicalId = data.id;
      }

      if (practicalId && testCases.length > 0) {
        const tcsToInsert = testCases.map((tc) => ({ practical_id: practicalId, ...tc }));
        await supabase.from("test_cases").insert(tcsToInsert);
      }

      onSaved();
    } catch (err) {
      console.error(err);
      alert("Failed to save practical. Try again.");
    } finally {
      setSaving(false);
    }
  };

  // ---------------------- Render ----------------------
  return (
    <div className="flex flex-col gap-3 p-3 md:p-3">

      {/* ---------- STEP 1: Practical Details ---------- */}
      {step === 1 && (
        <div className="bg-white dark:bg-gray-900 shadow-lg rounded-lg p-3 flex flex-col gap-3">

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

            {/* ---------- Left Column (Details + Test Cases) ---------- */}
            <div className="flex flex-col gap-4 col-span-1 max-h-[600px] overflow-y-auto">

              {/* Practical Title */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">
                  Practical Title *
                </label>

                <input
                  type="text"
                  name="title"
                  value={form.title}
                  onChange={handleInput}
                  placeholder="Enter practical title"
                  className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 dark:bg-gray-800 dark:text-white"
                />
              </div>

              {/* Subject */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">Subject *</label>
                <select
                  name="subject_id"
                  value={form.subject_id}
                  onChange={handleInput}
                  className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 dark:bg-gray-800 dark:text-white"
                >
                  {subjects.map((s) => (
                    <option key={s.id} value={s.id}>{s.subject_name}</option>
                  ))}
                </select>
              </div>

              {/* Deadline */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">Deadline *</label>
                <input
                  type="datetime-local"
                  name="deadline"
                  value={form.deadline}
                  onChange={handleInput}
                  className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 dark:bg-gray-800 dark:text-white"
                />
              </div>

              {/* Max Marks */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">Max Marks *</label>
                <input
                  type="number"
                  name="max_marks"
                  value={form.max_marks}
                  onChange={handleInput}
                  className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 dark:bg-gray-800 dark:text-white"
                />
              </div>

              {/* Test Cases */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">Test Cases</label>
                <div className="flex flex-col gap-2 mt-2 bg-gray-50 dark:bg-gray-800 rounded-lg p-3 max-h-[400px] overflow-y-auto">
                  {testCases.map((tc, index) => (
                    <div key={index} className="flex flex-col md:flex-row items-start md:items-center gap-2 bg-white dark:bg-gray-700 p-2 rounded-lg shadow-sm">
                      <div className="flex-1 flex flex-col">
                        <label className="text-gray-500 dark:text-gray-300 text-xs">Input</label>
                        <input
                          type="text"
                          value={tc.input}
                          onChange={(e) => handleTestCaseChange(index, "input", e.target.value)}
                          className="border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-1 text-sm dark:bg-gray-800 dark:text-white focus:ring-1 focus:ring-blue-400"
                        />
                      </div>
                      <div className="flex-1 flex flex-col">
                        <label className="text-gray-500 dark:text-gray-300 text-xs">Expected Output</label>
                        <input
                          type="text"
                          value={tc.expected_output}
                          onChange={(e) => handleTestCaseChange(index, "expected_output", e.target.value)}
                          className="border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-1 text-sm dark:bg-gray-800 dark:text-white focus:ring-1 focus:ring-blue-400"
                        />
                      </div>
                      <button
                        onClick={() => removeTestCase(index)}
                        className="text-red-600 hover:text-red-800 font-bold text-xl md:mt-0 mt-2"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                  <button
                    onClick={addTestCase}
                    className="mt-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium w-max"
                  >
                    + Add Test Case
                  </button>
                </div>
              </div>
            </div>

            {/* ---------- Right Column (Description + Reference Code) ---------- */}
            <div className="flex flex-col gap-4 col-span-2 max-h-[600px] overflow-y-auto">

              {/* Description */}
              <div className="flex flex-col">
                <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">Description / Question Details</label>
                <textarea
                  name="description"
                  value={form.description}
                  onChange={handleInput}
                  placeholder="Provide detailed description or instructions for the practical"
                  rows={12}
                  className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-blue-400 w-full resize-none"
                />
              </div>

              {/* Reference Code */}
              <div className="flex flex-col">
                <div className="flex items-center justify-between">
                  <label className="text-gray-600 dark:text-gray-400 text-sm font-bold">
                    Reference / Sample Code
                  </label>
                  <select
                    value={sampleLanguage || "c"}
                    onChange={(e) => setSampleLanguage(e.target.value)}
                    className="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-1 text-sm w-36 dark:bg-gray-800 dark:text-white"
                  >
                    <option value="c">C </option>
                    <option value="python">Python</option>
                  </select>
                </div>
                <CodeMirror
                  value={sampleCode}
                  onChange={setSampleCode}
                  height="260px"
                  theme={theme === "dark" ? oneDark : undefined}
                  extensions={[getLanguageExtension()]}
                  className="rounded-lg border overflow-hidden mt-2"
                />

              </div>

            </div>
          </div>

          <div className="mt-4 flex justify-end gap-2">
            <button
              onClick={async () => {
                await handleSave(); // Save the practical
                handleNext();       // Move to Step 2
              }}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"
              disabled={saving}
            >
              {saving ? "Saving..." : "Save & Next"}
            </button>
          </div>

        </div>
      )}

      {/* ---------- STEP 2: Assign Students ---------- */}
      {step === 2 && (
        <div className="bg-white dark:bg-gray-800 shadow rounded p-4 flex flex-col gap-3 text-xs">
          <h3 className="font-semibold text-lg mb-2">Assign Practical to Students</h3>

          <div className="flex flex-col">
            <label className="block text-sm font-medium mb-1">Deadline</label>
            <input
              type="datetime-local"
              value={assignmentDeadline}
              onChange={(e) => setAssignmentDeadline(e.target.value)}
              className="w-full px-2 py-1 border rounded text-xs dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div className="flex flex-col">
            <label className="block text-sm font-medium mb-1">Notes</label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Optional notes"
              className="w-full px-2 py-1 border rounded h-20 text-xs dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div className="flex flex-col">
            <label className="block text-sm font-medium mb-1">Select Students ({selectedStudents.length} selected)</label>
            <div className="max-h-40 overflow-y-auto border rounded p-2">
              {error ? (
                <p className="text-red-500 text-sm">{error}</p>
              ) : students.length === 0 ? (
                <p className="text-gray-500 text-sm">No students available to assign.</p>
              ) : (
                students.map((student) => (
                  <label key={student.uid} className="flex items-center space-x-2 p-1 hover:bg-gray-50 dark:hover:bg-gray-800 rounded">
                    <input
                      type="checkbox"
                      checked={selectedStudents.some((s) => s.uid === student.uid)}
                      onChange={() => toggleStudent(student)}
                    />
                    <span>{student.name} ({student.email})</span>
                  </label>
                ))
              )}
            </div>
          </div>

          <div className="flex justify-between gap-2 mt-2">
            <button onClick={handleBack} className="px-3 py-1 border rounded text-xs">Back</button>
            <button
              onClick={assign}
              disabled={selectedStudents.length === 0 || loading}
              className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs disabled:opacity-50"
            >
              {loading ? "Assigning..." : `Assign to ${selectedStudents.length} Student${selectedStudents.length !== 1 ? "s" : ""}`}
            </button>
          </div>
        </div>
      )}

    </div>
  );
}

